<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Blanks Audit Report</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(to right, #eef4f9, #d0e0ed); 
            background-attachment: fixed;
        }
        
        /* General Containers and Styles */
        h1, .controles, table {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 10px;
        }
        h1 { 
            text-align: center; 
            color: #003366; 
            margin-bottom: 20px;
            font-size: 2em;
        }
        .controles { 
            margin-bottom: 20px; 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            align-items: flex-start;
            gap: 25px; 
        }
        .control-group {
            display: flex;
            flex-direction: column; 
            align-items: flex-start;
            padding: 10px;
            border: 1px solid #ccc; 
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .control-group label {
            font-weight: bold;
            color: #003366;
            margin-bottom: 5px;
        }
        select, .btn { 
            padding: 8px 12px; 
            border-radius: 5px; 
            border: 1px solid #003366; 
            font-weight: bold; 
        }
        .btn { 
            background: #0066cc; 
            color: white; 
            cursor: pointer; 
            margin-top: 15px; 
        }
        .btn:hover { background: #004c99; }
        
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; }
        table, th, td { border: 1px solid #666; }
        th, td { padding: 8px; text-align: center; vertical-align: middle; }
        th { background: #003366; color: white; }
        
        /* Input Styles */
        input[type="number"], input[type="text"], select, textarea { 
            width: 90%; 
            padding: 5px; 
            border-radius: 5px; 
            border: 1px solid #ccc; 
            box-sizing: border-box; 
        }
        select.codigo-defecto { width: 60%; }
        input.cantidad-defecto { width: 30%; }
        textarea.comentarios-area { min-height: 50px; resize: vertical; }

        /* A/R (Accept/Reject) Styles */
        .ar-acepta { background-color: #c8f7c5; font-weight: bold; font-size: 14px; height: 30px; line-height: 18px; }
        .ar-rechaza { background-color: #f7c5c5; font-weight: bold; font-size: 14px; height: 30px; line-height: 18px; }
        
        /* Defect Section Styles */
        .small-btn { padding: 4px 8px; font-size: 12px; margin-top:6px; display:inline-block; }
        .defect-row { margin-top:6px; display:flex; gap:3px; justify-content:center; align-items:center; }
    </style>
</head>
<body>

<h1>Blanks Audit Report</h1>

<div class="controles">
    
    <div class="control-group">
        <label for="product-type">Product Type:</label>
        <select id="product-type" onchange="manejarCambioDeProducto()">
            <option value="CAPS">üß¢ Caps</option>
            <option value="GARMENTS">üëï Garments</option>
        </select>
    </div>
    
    <div class="control-group">
        <label for="vendor">Vendor:</label>
        <select id="vendor">
            <option value="">-- Select Vendor --</option>
        </select>
    </div>
    
    <div class="control-group" style="border: none; background: none; padding-top: 25px;">
        <button class="btn" onclick="agregarFila()">‚ûï Add Item</button>
        <button class="btn" id="descargarSoloExcel">‚¨áÔ∏è Download Excel</button>
    </div>
</div>

<table id="tabla">
    <thead>
        <tr>
            <th>Invoice</th>
            <th>PO</th>
            <th>Style</th>
            <th>Color</th>
            <th>Total Qty</th>
            <th>Sample Size</th>
            <th>Defects (Code / Qty)</th> 
            <th>Total Defects</th>
            <th>AQL %</th>
            <th>A/R</th>
            <th>Comments / Observations</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><input type="text" name="factura[]"></td>
            <td><input type="text" name="po[]"></td>
            <td><input type="text" name="estilo[]"></td>
            <td><input type="text" name="color[]"></td>
            <td><input type="number" name="total[]" min="0" oninput="calcularFila(this.closest('tr'))"></td>
            <td><input type="text" name="muestra[]" readonly></td>
            
            <td>
                <div class="defectos">
                    <div class="defect-row">
                        <select class="codigo-defecto">
                            <option value="">-- Select Defect --</option>
                        </select>
                        <input type="number" placeholder="Qty." class="cantidad-defecto" min="0" oninput="calcularFila(this.closest('tr'))">
                        <button type="button" class="btn small-btn" onclick="quitarDefecto(this)">‚àí</button>
                    </div>
                </div>
                <button type="button" class="btn small-btn" onclick="agregarDefecto(this)">‚ûï Defect</button>
            </td>

            <td><input type="text" name="totalDefectos[]" readonly></td>
            <td><input type="text" name="aql[]" readonly></td>
            <td><input type="text" name="ar[]" readonly></td>

            <td>
                <textarea name="comentarios[]" class="comentarios-area" placeholder="Write observations here..."></textarea>
            </td>
        </tr>
    </tbody>
</table>

<script>
// ===========================================
//             CONFIGURATION DATA
// ===========================================

const PROVEEDORES = {
    CAPS: [ 
        "Asia Caps (Thailand) Co., Ltd.", "Asia Caps Co., Ltd.", "ERA Fashion Accesory Co.",
        "GOTOP TEXTILE COMPANY LIMITED", "Giant Headmost Manufacturing Corp", "HENAN J&F HEADWEAR CO., LTD",
        "Jeya Headwear", "Ratone International LTD. Loc",
        "Shiningcrown Hats Mfg., Corp.", "Unimas Sportswear Ltd.", "Ouray Sportswear" 
    ],
    GARMENTS: [ 
        "New Trend Vietnam Co. Ltd.", "Global Knitwear Limited", "New Wave Apparel",
        "Green Valley Manufacturing", "Solis Textiles",
        "Al-Ameera (Pvt) Ltd.", "E.W. YEN JOINT STOCK COMPANY", "FRUIT OF THE LOOM",
        "M/S.J-WIN FASHIONS", "Marva Exports", "Metrotex Industries",
        "Milestone Textiles", "Ningbo Wollomtex Apparel Co. Ltd.", "Ouray Sportswear" 
    ]
};

const DEFECTOS_POR_TIPO = {
    CAPS: [
        "OIL / GREASE", "STAIN / DIRT", "HOLES", "MISSING UNSEWN LABEL", "OPEN SEAM",
        "PUCKERING SEAM", "FABRIC DEFECT", "LONG THREAD", "INCORRECT MEASUREMENTS",
        "MISSING STITCH", "RAID EDGE", "NEEDLE HOLES", "TAB", "PLEAT",
        "DROPPED STITCH", "BROKEN STITCH", "SKIPPED STITCH", "SHADE BETWEEN PARTS",
        "INCORRECT CAP COLOR", "BROKEN VISOR", "UNSEWED / MISSING EYELET",
        "DEFECTIVE PLASTIC SNAP BACK", "DEFECTIVE STRAP BUCKLE", "DEFECTIVE STRAP VELCRO",
        "INCORRECT WASH EFFECT", "WASH UNSIGHTLY STREAKS", "DISALIGNED VISOR",
        "STICKER RESIDUE", "DAMAGED CAUSED BY HANGTAG", "IMPROPER ROPE TENSION",
        "SWEATBAND SHOWING", "SHOWING MESH BELOW CROWN EDGE"
    ],
    GARMENTS: [
        "HOLES", "CUTS", "OPEN SEAM", "BAD APPEARANCE", "BROKEN STITCHES", "DIRTY",
        "DROPPED STITCHES", "EXCESSIVE FULLNESS", "FABRIC FLAW", "INCORRECT MEASUREMENTS",
        "INCORRECT PATCH OF STITCHES", "INCORRET COMPONENT", "LOOSE TENSION STITCHES",
        "MISPLACED COMPONENT", "MISSING COMPONENT", "MISSING OPERATION", "NEEDLE HOLES",
        "OIL / GREASE", "PILLING", "PLEAT", "POINTING MARKS", "PRESS MARKS",
        "PUCKERING SEAM", "SHADDING PARTS", "SHORES", "SKIPPED STITCHES",
        "SPI OUT OF TOLERANE", "TIGHT TENSION STITCHES", "TWISTED GARMENT",
        "UNEVEN GATERING", "UNEVEN PARTS", "UNEVEN STITCHES MARGEN",
        "UNSECURE COMPONENT", "UNTRIMMED THREAD", "VISSIBLE TACK STITCH",
        "WEAVY SEAM", "WRONG COLOR THREAD", "OTHER"
    ]
};

const rangos = [
    {min:2, max:8, muestra:2, acepta:0, rechaza:1},
    {min:9, max:15, muestra:3, acepta:0, rechaza:1},
    {min:16, max:25, muestra:5, acepta:0, rechaza:1},
    {min:26, max:50, muestra:8, acepta:0, rechaza:1},
    {min:51, max:90, muestra:13, acepta:1, rechaza:2},
    {min:91, max:150, muestra:20, acepta:1, rechaza:2},
    {min:151, max:280, muestra:32, acepta:2, rechaza:3},
    {min:281, max:500, muestra:50, acepta:3, rechaza:4},
    {min:501, max:1200, muestra:80, acepta:5, rechaza:6},
    {min:1201, max:3200, muestra:125, acepta:7, rechaza:8},
    {min:3201, max:10000, muestra:200, acepta:10, rechaza:11},
    {min:10001, max:35000, muestra:315, acepta:14, rechaza:15}
];

// ===========================================
//             CONTROL FUNCTIONS 
// ===========================================

/**
 * Crea las opciones HTML para el selector de defectos basado en el tipo de producto.
 * @param {string} tipoProducto - 'CAPS' o 'GARMENTS'.
 * @returns {string} HTML de las opciones.
 */
function crearSelectDefectos(tipoProducto) {
    const lista = DEFECTOS_POR_TIPO[tipoProducto] || DEFECTOS_POR_TIPO.CAPS;
    let options = `<option value="">-- Select Defect --</option>`;
    lista.forEach(defecto => {
        options += `<option value="${defecto}">${defecto}</option>`;
    });
    return options;
}

/**
 * Actualiza todos los selectores de defectos existentes en la tabla.
 * Mantiene el valor seleccionado si el defecto sigue siendo v√°lido para el nuevo tipo.
 * @param {string} tipoProducto - 'CAPS' o 'GARMENTS'.
 */
function actualizarSelectoresDefectos(tipoProducto) {
    const nuevosOptions = crearSelectDefectos(tipoProducto);
    
    document.querySelectorAll('select.codigo-defecto').forEach(select => {
        const valorAnterior = select.value; 
        
        select.innerHTML = nuevosOptions;
        
        // Intenta restablecer el valor anterior si es v√°lido
        if (select.querySelector(`option[value="${valorAnterior}"]`)) {
            select.value = valorAnterior;
        } else {
            select.value = "";
        }
    });
}

/**
 * Carga los proveedores en el selector principal bas√°ndose en el tipo de producto.
 * @param {string} tipoProducto - 'CAPS' o 'GARMENTS'.
 */
function cargarProveedores(tipoProducto) {
    const selectorVendor = document.getElementById("vendor");
    
    selectorVendor.innerHTML = '<option value="">-- Select Vendor --</option>';
    
    const lista = PROVEEDORES[tipoProducto] || [];
    
    lista.forEach(vendor => {
        const option = document.createElement('option');
        option.value = vendor;
        option.textContent = vendor;
        selectorVendor.appendChild(option);
    });
}

/**
 * Funci√≥n principal llamada al cambiar el tipo de producto (CAPS/GARMENTS).
 */
function manejarCambioDeProducto() {
    const tipoProducto = document.getElementById("product-type").value;
    cargarProveedores(tipoProducto);
    actualizarSelectoresDefectos(tipoProducto);
}

/**
 * Calcula la muestra, los defectos totales y el A/R para una fila.
 * @param {HTMLElement} fila - La fila de la tabla a calcular.
 */
function calcularFila(fila) {
    let total = parseInt(fila.querySelector('[name="total[]"]').value) || 0;
    let defectosTot = 0;

    // Suma de defectos
    fila.querySelectorAll('.cantidad-defecto').forEach(input => {
        defectosTot += parseInt(input.value) || 0;
    });

    const inputMuestra = fila.querySelector('[name="muestra[]"]');
    const inputAR = fila.querySelector('[name="ar[]"]');
    const inputAQL = fila.querySelector('[name="aql[]"]');
    const inputTotalDef = fila.querySelector('[name="totalDefectos[]"]');

    const rango = rangos.find(r => total >= r.min && total <= r.max);

    if (rango) {
        inputMuestra.value = rango.muestra;
        inputTotalDef.value = defectosTot;
        let aql = rango.muestra ? ((defectosTot / rango.muestra) * 100).toFixed(2) : "0.00";
        inputAQL.value = aql + "%";

        // Determinar Aceptar/Rechazar
        if (defectosTot <= rango.acepta) {
            inputAR.value = `ACCEPT ${rango.acepta}`;
            inputAR.className = "ar-acepta";
        } else {
            inputAR.value = `REJECT ${rango.acepta}`;
            inputAR.className = "ar-rechaza";
        }
    } else {
        // Limpiar campos si no hay rango (Total Qty es 0 o fuera de rango)
        inputMuestra.value = "";
        inputAR.value = "";
        inputAQL.value = "";
        inputTotalDef.value = "";
        inputAR.className = "";
    }
}

/**
 * Agrega una nueva fila de auditor√≠a a la tabla.
 */
function agregarFila() {
    const tabla = document.querySelector("#tabla tbody");
    const fila = document.createElement("tr");
    
    const tipoProductoActual = document.getElementById("product-type").value;
    
    fila.innerHTML = `
        <td><input type="text" name="factura[]"></td>
        <td><input type="text" name="po[]"></td>
        <td><input type="text" name="estilo[]"></td>
        <td><input type="text" name="color[]"></td>
        <td><input type="number" name="total[]" min="0" oninput="calcularFila(this.closest('tr'))"></td>
        <td><input type="text" name="muestra[]" readonly></td>

        <td>
            <div class="defectos">
                <div class="defect-row">
                    <select class="codigo-defecto">
                        ${crearSelectDefectos(tipoProductoActual)}
                    </select>
                    <input type="number" placeholder="Qty." class="cantidad-defecto" min="0" oninput="calcularFila(this.closest('tr'))">
                    <button type="button" class="btn small-btn" onclick="quitarDefecto(this)">‚àí</button>
                </div>
            </div>
            <button type="button" class="btn small-btn" onclick="agregarDefecto(this)">‚ûï Defect</button>
        </td>

        <td><input type="text" name="totalDefectos[]" readonly></td>
        <td><input type="text" name="aql[]" readonly></td>
        <td><input type="text" name="ar[]" readonly></td>

        <td>
            <textarea name="comentarios[]" class="comentarios-area" placeholder="Write observations here..."></textarea>
        </td>
    `;
    tabla.appendChild(fila);
}

/**
 * Agrega un nuevo campo de defecto (C√≥digo/Cantidad) a una fila existente.
 * @param {HTMLElement} btn - El bot√≥n "‚ûï Defect" que se presion√≥.
 */
function agregarDefecto(btn) {
    const cell = btn.parentNode.querySelector('.defectos');
    const div = document.createElement('div');
    div.className = 'defect-row';
    div.style.marginTop = '6px';
    
    const tipoProductoActual = document.getElementById("product-type").value;
    
    div.innerHTML = `
        <select class="codigo-defecto">
            ${crearSelectDefectos(tipoProductoActual)}
        </select>
        <input type="number" placeholder="Qty." class="cantidad-defecto" min="0" oninput="calcularFila(this.closest('tr'))">
        <button type="button" class="btn small-btn" onclick="quitarDefecto(this)">‚àí</button>
    `;
    cell.appendChild(div);
}

/**
 * Quita un campo de defecto de una fila y recalcula.
 * @param {HTMLElement} btn - El bot√≥n "‚àí" que se presion√≥.
 */
function quitarDefecto(btn) {
    const row = btn.closest('.defect-row');
    if (!row) return;
    const tr = row.closest('tr');
    row.remove();
    if (tr) calcularFila(tr);
}


// ===========================================
//             EXCEL DOWNLOAD FUNCTION
// ===========================================

function obtenerFechaHoy() {
    const today = new Date();
    const dd = String(today.getDate()).padStart(2, '0');
    const mm = String(today.getMonth() + 1).padStart(2, '0'); 
    const yyyy = today.getFullYear();
    return `${dd}-${mm}-${yyyy}`;
}

function generarNombreArchivo(factura) {
    const today = new Date();
    const dd = String(today.getDate()).padStart(2, '0');
    const mm = String(today.getMonth() + 1).padStart(2, '0'); 
    const yyyy = today.getFullYear();
    const fecha = `${dd}-${mm}-${yyyy}`;

    const safeFactura = factura.replace(/[^\w\-]+/g, "_") || "Report";
    return `${safeFactura}_${fecha}`;
}

function recolectarDatos() {
    const vendor = document.getElementById("vendor").value || "NoVendor";
    const fechaAuditoria = obtenerFechaHoy(); 
    const filas = document.querySelectorAll("#tabla tbody tr");
    const datos = [];
    let primeraFactura = "";

    filas.forEach(tr => {
        const celdas = tr.querySelectorAll("td");
        if (!celdas || celdas.length < 9) return; 

        const facturaValor = (celdas[0].querySelector('input') ? celdas[0].querySelector('input').value : "").trim();
        if (primeraFactura === "" && facturaValor !== "") {
            primeraFactura = facturaValor;
        }

        const defectoDatos = {};
        const defectCell = celdas[6];
        
        Array.from(defectCell.querySelectorAll('.defect-row')).forEach(div => {
            const codSelect = div.querySelector('.codigo-defecto');
            const qtyInput = div.querySelector('.cantidad-defecto');
            const cod = codSelect ? codSelect.value.trim() : ""; 
            const qty = parseInt(qtyInput ? qtyInput.value.trim() : "0") || 0;
            
            if (cod && qty > 0) {
                defectoDatos[cod] = (defectoDatos[cod] || 0) + qty;
            }
        });

        const defectosLista = Object.entries(defectoDatos).map(([codigo, cantidad]) => ({ codigo, cantidad }));
        const numDefectosUnicos = defectosLista.length;

        const datosComunesFull = {
            "Audit Date": fechaAuditoria, "Vendor": vendor, "Invoice": (celdas[0].querySelector('input') ? celdas[0].querySelector('input').value : "").trim(), 
            "PO": (celdas[1].querySelector('input') ? celdas[1].querySelector('input').value : "").trim(), "Style": (celdas[2].querySelector('input') ? celdas[2].querySelector('input').value : "").trim(), 
            "Color": (celdas[3].querySelector('input') ? celdas[3].querySelector('input').value : "").trim(), "Total Qty": (celdas[4].querySelector('input') ? celdas[4].querySelector('input').value : "").trim(), 
            "Sample Size": (celdas[5].querySelector('input') ? celdas[5].querySelector('input').value : "").trim(), "Total Defects": (celdas[7].querySelector('input') ? celdas[7].querySelector('input').value : "").trim(), 
            "AQL %": (celdas[8].querySelector('input') ? celdas[8].querySelector('input').value : "").trim(), "A/R": (celdas[9].querySelector('input') ? celdas[9].querySelector('input').value : "").trim(),
            "Comments": (celdas[10].querySelector('textarea') ? celdas[10].querySelector('textarea').value : "").trim(), 
        };
        
        const datosComunesVacio = {
            "Audit Date": "", "Vendor": "", "Invoice": "", "PO": "", "Style": "", "Color": "", "Total Qty": "",
            "Sample Size": "", "Total Defects": "", "AQL %": "", "A/R": "", "Comments": "", 
        };
        
        if (numDefectosUnicos > 0) {
            defectosLista.forEach((defecto, index) => {
                let filaAuditoriaBase = (index === 0 ? datosComunesFull : datosComunesVacio);
                
                datos.push({
                    ...filaAuditoriaBase,
                    "Defect Code": defecto.codigo,
                    "Defect Quantity": defecto.cantidad,
                });
            });
        } else {
              const anyData = Object.values(datosComunesFull).some(v => v !== "" && v !== null && v !== 0);
              if (anyData) {
                datos.push({
                    ...datosComunesFull,
                    "Defect Code": "",
                    "Defect Quantity": "",
                });
              }
        }
    });

    return { datos, primeraFactura, vendor };
}

/**
 * Funci√≥n que genera y descarga el archivo Excel.
 */
function descargarSoloExcel() {
    const { datos, vendor, primeraFactura } = recolectarDatos();

    if (datos.length === 0) {
        alert("No data to export. Please add at least one row with information.");
        return;
    }

    const ws = XLSX.utils.json_to_sheet(datos);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Audit");
    
    const nombreBase = generarNombreArchivo(primeraFactura || vendor);
    const nombreArchivo = `${nombreBase}.xlsx`;
    
    // Ejecuta la descarga del archivo
    XLSX.writeFile(wb, nombreArchivo);
    alert(`The Excel file "${nombreArchivo}" has been downloaded.`);
}

// Attach the function to the button
document.getElementById("descargarSoloExcel").addEventListener("click", descargarSoloExcel);

// Initialization
window.onload = function() {
    manejarCambioDeProducto(); // Carga CAPS y sus proveedores/defectos al iniciar
    // Recalcula la fila de ejemplo inicial (si tiene datos)
    const primeraFila = document.querySelector("#tabla tbody tr");
    if (primeraFila) calcularFila(primeraFila); 
};
</script>

</body>
</html>


